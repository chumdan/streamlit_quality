import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm

# í•œê¸€ í°íŠ¸ ì„¤ì •
plt.rcParams['font.family'] = 'Malgun Gothic'  # ìœˆë„ìš° ê¸°ë³¸ í•œê¸€ í°íŠ¸
plt.rcParams['axes.unicode_minus'] = False     # ë§ˆì´ë„ˆìŠ¤ ê¸°í˜¸ ê¹¨ì§ ë°©ì§€

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="ì œì•½ ê³µì • ë°ì´í„° ë¶„ì„ ì‹œìŠ¤í…œ",
    page_icon="ğŸ“Š",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ì„¸ì…˜ ìŠ¤í…Œì´íŠ¸ ì´ˆê¸°í™”
if 'data' not in st.session_state:
    st.session_state.data = None

# íƒ€ì´í‹€ ë° ì„¤ëª…
st.title('ì œì•½ ê³µì • ë°ì´í„° ë¶„ì„ ì‹œìŠ¤í…œ')
st.markdown('í”„ë¦¬ê·¸ë ì • ë°ì´í„° ê¸°ë°˜ ê³µì • ë¶„ì„ ì‹œìŠ¤í…œ í”„ë¡œí† íƒ€ì…ì…ë‹ˆë‹¤.')

# íŒŒì¼ ì—…ë¡œë“œ í•¨ìˆ˜
def upload_file():
    uploaded_file = st.file_uploader("CSV íŒŒì¼ ì—…ë¡œë“œ", type=["csv"])
    
    if uploaded_file is not None:
        try:
            # íŒŒì¼ ì¸ì½”ë”© ì‹œë„ (ì—¬ëŸ¬ ì¸ì½”ë”© ì‹œë„)
            encodings = ['cp949', 'utf-8', 'euc-kr']
            for encoding in encodings:
                try:
                    data = pd.read_csv(uploaded_file, encoding=encoding)
                    break
                except UnicodeDecodeError:
                    continue
            
            # ì»¬ëŸ¼ëª… ì •ë¦¬
            rename_dict = {
                'ì œì¡°ë²ˆí˜¸': 'ì œì¡°ë²ˆí˜¸', 'ìˆ˜ë¶„í•¨ëŸ‰(%)': 'ìˆ˜ë¶„í•¨ëŸ‰(%)', 'd(0.1)': 'd(0.1)', 
                'd(0.5)': 'd(0.5)', 'd(0.9)': 'd(0.9)', 'ì œí’ˆëª…': 'ì œí’ˆëª…', 
                'íƒ€ì •ê¸°': 'íƒ€ì •ê¸°', 'íƒ€ì • ì¼ì': 'íƒ€ì • ì¼ì', 'ê¸°í‘œíƒ€ì •ì¤‘ëŸ‰(mg)': 'ê¸°í‘œíƒ€ì •ì¤‘ëŸ‰(mg)', 
                'í‰ê· ì§ˆëŸ‰(mg)': 'í‰ê· ì§ˆëŸ‰(mg)', 'ì§ˆëŸ‰ë²”ìœ„_Min(mg)': 'ì§ˆëŸ‰ë²”ìœ„_Min(mg)', 
                'ì§ˆëŸ‰ë²”ìœ„_Max(mg)': 'ì§ˆëŸ‰ë²”ìœ„_Max(mg)', 'ê²½ë„_Min(N)': 'ê²½ë„_Min(N)', 
                'ê²½ë„_Max(N)': 'ê²½ë„_Max(N)', 'ë‘ê»˜_Min': 'ë‘ê»˜_Min', 'ë‘ê»˜_Max': 'ë‘ê»˜_Max', 
                'ë§ˆì†ë„(%)': 'ë§ˆì†ë„(%)', 'ë¶•í•´ë„(min)': 'ë¶•í•´ë„(min)', 'ì¶©ì „ê¹Šì´(mm)': 'ì¶©ì „ê¹Šì´(mm)', 
                'í˜¸í¼ì˜¤ë¦¬í”¼ìŠ¤(mm)': 'í˜¸í¼ì˜¤ë¦¬í”¼ìŠ¤(mm)', 'ë‹¤ì´ì§ê²½(mm)': 'ë‹¤ì´ì§ê²½(mm)', 
                'íƒ€ì •ì†ë„(rpm)': 'íƒ€ì •ì†ë„(rpm)', 'íƒ€ì••ë ¥(KN)': 'íƒ€ì••ë ¥(KN)', 
                'í˜¼í•©ê¸° ì†ë„(rpm)': 'í˜¼í•©ê¸° ì†ë„(rpm)', 'ìš©ì¶œ_ìµœì†Œ': 'ìš©ì¶œ_ìµœì†Œ', 
                'ìš©ì¶œ_ìµœëŒ€': 'ìš©ì¶œ_ìµœëŒ€', 'ì‘ì—…ì': 'ì‘ì—…ì'
            }
            
            # ë°ì´í„°í”„ë ˆì„ì˜ ì—´ ì´ë¦„ì„ ì¬ì •ì˜
            data.rename(columns=lambda x: rename_dict.get(x, x), inplace=True)
            
            st.session_state.data = data
            st.success('íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!')
            
            # ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
            st.subheader('ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°')
            st.dataframe(data.head())
            
            # ë°ì´í„° í†µê³„ ìš”ì•½
            st.subheader('ë°ì´í„° ìš”ì•½')
            st.write(f"í–‰ ìˆ˜: {data.shape[0]}, ì—´ ìˆ˜: {data.shape[1]}")
            
            # ë°ì´í„° ìœ í˜• í™•ì¸
            st.write("ë°ì´í„° ìœ í˜•:")
            st.write(data.dtypes)
            
        except Exception as e:
            st.error(f'íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}')
            st.session_state.data = None
    
    return st.session_state.data

# íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜
data = upload_file()

# ì‚¬ìš© ì•ˆë‚´
if data is None:
    st.info('ì™¼ìª½ ë©”ë‰´ì—ì„œ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•œ í›„, ìƒë‹¨ì˜ í˜ì´ì§€ íƒ­ì„ í†µí•´ ë‹¤ì–‘í•œ ë¶„ì„ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')
    
    # ìƒ˜í”Œ ì´ë¯¸ì§€ í‘œì‹œ
    st.subheader('ì‹œìŠ¤í…œ ê¸°ëŠ¥ ì„¤ëª…')
    st.markdown("""
    ### ì£¼ìš” ê¸°ëŠ¥:
    
    1. **ê³µì • ëŠ¥ë ¥ë¶„ì„**:
       - ë³€ìˆ˜ë³„ í†µê³„ëŸ‰ ë° ê³µì •ëŠ¥ë ¥ì§€ìˆ˜(Cp, Cpk) ê³„ì‚°
       - ê³µì • ê´€ë¦¬ë„ ë° ë¶„í¬ ì‹œê°í™”
       - ê³µì • ëŠ¥ë ¥ íŒì • ë° í•´ì„
    
    2. **í†µê³„ë¶„ì„**:
       - ë³€ìˆ˜ ê°„ ìƒê´€ê´€ê³„ ë¶„ì„ ë° ì‹œê°í™”
       - ì£¼ìš” ìƒê´€ë³€ìˆ˜ì™€ì˜ ì‚°ì ë„ ë° íšŒê·€ì„ 
       - ì„ íƒ ë³€ìˆ˜ì˜ ë°•ìŠ¤í”Œë¡¯ ë° ê¸°ìˆ í†µê³„ëŸ‰
    
    3. **íŠ¹ì´ê°’ë¶„ì„**:
       - ë°°ì¹˜ë³„ Z-Score ê³„ì‚° ë° ì‹œê°í™”
       - íŠ¹ì´ê°’ í•´ì„ ë° ìƒì„¸ ë¶„ì„
       - ì´ìƒê°’ ë¶„í¬ ë¶„ì„
    4. **ì‹œë®¬ë ˆì´ì…˜**:
       - ì—…ë¡œë“œí•œ ë°ì´í„° í•™ìŠµ ë° ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ ì¶œë ¥

    """)
else:
    st.success('ë°ì´í„°ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒë‹¨ ë©”ë‰´ì—ì„œ ì›í•˜ëŠ” ë¶„ì„ í˜ì´ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”!')